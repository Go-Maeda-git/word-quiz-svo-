import streamlit as st
import random

# 語尾データ (画像から抽出)
# 各エントリ: {"suffix": "語尾", "pos": "品詞", "examples": ["単語例1 (意味)", "単語例2 (意味)"], "note": "補足情報（あれば）"}
suffix_data_list = [
    # 名詞の語尾
    {"suffix": "-ance", "pos": "名詞", "examples": ["performance (公演)", "maintenance (保守点検)", "distance (距離)"], "note": None},
    {"suffix": "-cy", "pos": "名詞", "examples": ["policy (方針)", "emergency (緊急事態)", "agency (代理店)"], "note": None},
    {"suffix": "-sion", "pos": "名詞", "examples": ["decision (決定)", "extension (内線)", "permission (許可)"], "note": None},
    {"suffix": "-tion", "pos": "名詞", "examples": ["position (職)", "presentation (プレゼンテーション)", "information (情報)"], "note": None},
    {"suffix": "-ty", "pos": "名詞", "examples": ["community (共同体)", "facility (施設)", "opportunity (機会)"], "note": None},
    {"suffix": "-ness", "pos": "名詞", "examples": ["business (会社)", "effectiveness (効果)", "fitness (健康)"], "note": None},
    {"suffix": "-ment", "pos": "名詞", "examples": ["document (書類)", "department (部)", "management (経営)"], "note": None},
    {"suffix": "-sis", "pos": "名詞", "examples": ["analysis (分析)", "emphasis (強調)", "basis (基盤)"], "note": None},
    {"suffix": "-ee", "pos": "名詞", "examples": ["employee (従業員)", "trainee (研修生)"], "note": None},
    # 動詞の語尾
    {"suffix": "-fy", "pos": "動詞", "examples": ["identify (〜を明らかにする)", "notify (〜を知らせる)", "modify (〜を変更する)"], "note": None},
    {"suffix": "-ize/-ise", "pos": "動詞", "examples": ["realize (〜を認識する)", "organize (〜を準備する)", "specialize (専門にする)"], "note": "※ -ise の綴りも同意 (例: organise)"},
    {"suffix": "-en", "pos": "動詞", "examples": ["broaden (〜を広げる)", "widen (〜を広げる)", "sharpen (〜を研ぐ)"], "note": "形容詞などから動詞を作る働きがあります。"},
    {"suffix": "-ate", "pos": "動詞", "examples": ["create (〜を創造する)", "indicate (〜を示す)", "donate (〜を寄付する)"], "note": "形容詞の語尾にもなることがあります (例: considerate)。"},
    # 形容詞の語尾
    {"suffix": "-ous", "pos": "形容詞", "examples": ["delicious (おいしい)", "serious (本気の)", "previous (以前の)"], "note": None},
    {"suffix": "-ble", "pos": "形容詞", "examples": ["available (手に入る)", "possible (可能な)", "reasonable (手ごろな)"], "note": None},
    {"suffix": "-ful", "pos": "形容詞", "examples": ["successful (成功している)", "careful (慎重な)", "useful (役に立つ)"], "note": None},
    {"suffix": "-cal", "pos": "形容詞", "examples": ["local (地元の)", "historical (歴史的な)", "economical (経済的な)"], "note": None},
    {"suffix": "-cial", "pos": "形容詞", "examples": ["financial (財政の)", "special (特別な)", "official (公式な)"], "note": None},
    {"suffix": "-nal", "pos": "形容詞", "examples": ["international (国際的な)", "additional (追加の)", "personal (個人的な)"], "note": None},
    {"suffix": "-ive", "pos": "形容詞", "examples": ["expensive (値段が高い)", "effective (効果的な)", "competitive (競争力のある)"], "note": None},
    # 副詞の語尾
    {"suffix": "-ly", "pos": "副詞", "examples": ["usually (普通は)", "recently (最近)", "frequently (頻繁に)"], "note": "【要注意】名詞に -ly がつくと形容詞になるものがあります (例: friendly, costly, timely, daily)。"},
    # -ly が形容詞になるケースも個別に追加 (クイズのバリエーションとして)
    {"suffix": "-ly (例外)", "pos": "形容詞", "examples": ["friendly (親切な)", "costly (費用のかかる)", "orderly (整然とした)", "timely (タイミングのいい)", "daily (毎日の)"], "note": "これらは名詞に -ly がついて形容詞になった例です。"},
]

# セッションステートの初期化関数
def initialize_session_state():
    if "suffix_list" not in st.session_state:
        st.session_state.suffix_list = random.sample(suffix_data_list, len(suffix_data_list))
    if "current_suffix_index" not in st.session_state:
        st.session_state.current_suffix_index = 0
    if "suffix_score" not in st.session_state:
        st.session_state.suffix_score = 0
    if "suffix_answered" not in st.session_state:
        st.session_state.suffix_answered = False
    if "suffix_user_choice" not in st.session_state:
        st.session_state.suffix_user_choice = None
    if "suffix_show_feedback" not in st.session_state:
        st.session_state.suffix_show_feedback = False

# 回答を処理する関数
def handle_suffix_answer(choice, correct_pos):
    st.session_state.suffix_answered = True
    st.session_state.suffix_user_choice = choice
    st.session_state.suffix_show_feedback = True
    if choice == correct_pos:
        st.session_state.suffix_score += 1

# 次の問題へ進む関数
def next_suffix_question():
    st.session_state.current_suffix_index += 1
    st.session_state.suffix_answered = False
    st.session_state.suffix_user_choice = None
    st.session_state.suffix_show_feedback = False

# --- アプリのメイン部分 ---
def main():
    st.set_page_config(page_title="語尾で品詞クイズ", layout="centered")
    st.title("🔎 語尾で品詞クイズ")
    st.markdown("表示された語尾が、主にどの品詞で使われるかを選んでください。")
    st.divider()

    initialize_session_state()

    suffix_list = st.session_state.suffix_list
    current_index = st.session_state.current_suffix_index

    if current_index < len(suffix_list):
        question_data = suffix_list[current_index]
        suffix_to_guess = question_data["suffix"]
        correct_pos = question_data["pos"]
        example_words = question_data["examples"]
        note_text = question_data["note"]

        st.subheader(f"問題 {current_index + 1} / {len(suffix_list)}")
        # 語尾を大きく表示
        if suffix_to_guess == "-ly (例外)":
            st.markdown(f"<h2 style='text-align: center; color: #FF6347;'>-ly</h2>", unsafe_allow_html=True)
            st.markdown("<p style='text-align: center;'>※ ただし、これが形容詞になる場合の例です。</p>", unsafe_allow_html=True)
        else:
            st.markdown(f"<h2 style='text-align: center; color: #1E90FF;'>{suffix_to_guess}</h2>", unsafe_allow_html=True)
        st.markdown("---")

        # 品詞の選択肢
        pos_options = ["名詞", "動詞", "形容詞", "副詞"]

        if not st.session_state.suffix_show_feedback:
            cols = st.columns(len(pos_options))
            for i, option in enumerate(pos_options):
                with cols[i]:
                    if st.button(option, key=f"pos_button_{option}_{current_index}", use_container_width=True, type="primary"):
                        handle_suffix_answer(option, correct_pos)
                        st.rerun()

        if st.session_state.suffix_show_feedback:
            user_choice = st.session_state.suffix_user_choice
            if user_choice == correct_pos:
                st.success(f"正解！ 🎉 「{suffix_to_guess}」は主に **{correct_pos}** の語尾です。")
            else:
                st.error(f"残念！ 「{suffix_to_guess}」の主な品詞は **{correct_pos}** でした。(あなたの回答: {user_choice})")

            st.markdown("**単語例:**")
            for ex in example_words:
                st.markdown(f"- {ex}")

            if note_text:
                st.info(f"📝 **補足:** {note_text}")
            st.markdown("---")

            if st.button("次の問題へ", key=f"next_suffix_button_{current_index}", use_container_width=True):
                next_suffix_question()
                st.rerun()

    else: # 全問終了
        st.balloons()
        st.header("🎉 クイズ終了！ 🎉")
        st.subheader("あなたの成績:")
        accuracy = (st.session_state.suffix_score / len(suffix_list)) * 100 if len(suffix_list) > 0 else 0
        st.markdown(f"**📖 総問題数:** {len(suffix_list)}")
        st.markdown(f"**✅ 正解数:** {st.session_state.suffix_score}")
        st.markdown(f"**🎯 正答率:** {accuracy:.2f}%")
        st.divider()

        if st.button("もう一度挑戦する", use_container_width=True, type="primary"):
            # セッションステートをリセットして再開
            keys_to_delete = [key for key in st.session_state.keys() if key.startswith("suffix_") or key == "current_suffix_index"]
            for key in keys_to_delete:
                del st.session_state[key]
            st.rerun()

if __name__ == "__main__":
    main()
