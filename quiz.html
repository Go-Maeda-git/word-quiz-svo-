import streamlit as st
import random

# èªå°¾ãƒ‡ãƒ¼ã‚¿ (ç”»åƒã‹ã‚‰æŠ½å‡º)
# å„ã‚¨ãƒ³ãƒˆãƒª: {"suffix": "èªå°¾", "pos": "å“è©", "examples": ["å˜èªä¾‹1 (æ„å‘³)", "å˜èªä¾‹2 (æ„å‘³)"], "note": "è£œè¶³æƒ…å ±ï¼ˆã‚ã‚Œã°ï¼‰"}
suffix_data_list = [
    # åè©ã®èªå°¾
    {"suffix": "-ance", "pos": "åè©", "examples": ["performance (å…¬æ¼”)", "maintenance (ä¿å®ˆç‚¹æ¤œ)", "distance (è·é›¢)"], "note": None},
    {"suffix": "-cy", "pos": "åè©", "examples": ["policy (æ–¹é‡)", "emergency (ç·Šæ€¥äº‹æ…‹)", "agency (ä»£ç†åº—)"], "note": None},
    {"suffix": "-sion", "pos": "åè©", "examples": ["decision (æ±ºå®š)", "extension (å†…ç·š)", "permission (è¨±å¯)"], "note": None},
    {"suffix": "-tion", "pos": "åè©", "examples": ["position (è·)", "presentation (ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³)", "information (æƒ…å ±)"], "note": None},
    {"suffix": "-ty", "pos": "åè©", "examples": ["community (å…±åŒä½“)", "facility (æ–½è¨­)", "opportunity (æ©Ÿä¼š)"], "note": None},
    {"suffix": "-ness", "pos": "åè©", "examples": ["business (ä¼šç¤¾)", "effectiveness (åŠ¹æœ)", "fitness (å¥åº·)"], "note": None},
    {"suffix": "-ment", "pos": "åè©", "examples": ["document (æ›¸é¡)", "department (éƒ¨)", "management (çµŒå–¶)"], "note": None},
    {"suffix": "-sis", "pos": "åè©", "examples": ["analysis (åˆ†æ)", "emphasis (å¼·èª¿)", "basis (åŸºç›¤)"], "note": None},
    {"suffix": "-ee", "pos": "åè©", "examples": ["employee (å¾“æ¥­å“¡)", "trainee (ç ”ä¿®ç”Ÿ)"], "note": None},
    # å‹•è©ã®èªå°¾
    {"suffix": "-fy", "pos": "å‹•è©", "examples": ["identify (ã€œã‚’æ˜ã‚‰ã‹ã«ã™ã‚‹)", "notify (ã€œã‚’çŸ¥ã‚‰ã›ã‚‹)", "modify (ã€œã‚’å¤‰æ›´ã™ã‚‹)"], "note": None},
    {"suffix": "-ize/-ise", "pos": "å‹•è©", "examples": ["realize (ã€œã‚’èªè­˜ã™ã‚‹)", "organize (ã€œã‚’æº–å‚™ã™ã‚‹)", "specialize (å°‚é–€ã«ã™ã‚‹)"], "note": "â€» -ise ã®ç¶´ã‚Šã‚‚åŒæ„ (ä¾‹: organise)"},
    {"suffix": "-en", "pos": "å‹•è©", "examples": ["broaden (ã€œã‚’åºƒã’ã‚‹)", "widen (ã€œã‚’åºƒã’ã‚‹)", "sharpen (ã€œã‚’ç ”ã)"], "note": "å½¢å®¹è©ãªã©ã‹ã‚‰å‹•è©ã‚’ä½œã‚‹åƒããŒã‚ã‚Šã¾ã™ã€‚"},
    {"suffix": "-ate", "pos": "å‹•è©", "examples": ["create (ã€œã‚’å‰µé€ ã™ã‚‹)", "indicate (ã€œã‚’ç¤ºã™)", "donate (ã€œã‚’å¯„ä»˜ã™ã‚‹)"], "note": "å½¢å®¹è©ã®èªå°¾ã«ã‚‚ãªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ (ä¾‹: considerate)ã€‚"},
    # å½¢å®¹è©ã®èªå°¾
    {"suffix": "-ous", "pos": "å½¢å®¹è©", "examples": ["delicious (ãŠã„ã—ã„)", "serious (æœ¬æ°—ã®)", "previous (ä»¥å‰ã®)"], "note": None},
    {"suffix": "-ble", "pos": "å½¢å®¹è©", "examples": ["available (æ‰‹ã«å…¥ã‚‹)", "possible (å¯èƒ½ãª)", "reasonable (æ‰‹ã”ã‚ãª)"], "note": None},
    {"suffix": "-ful", "pos": "å½¢å®¹è©", "examples": ["successful (æˆåŠŸã—ã¦ã„ã‚‹)", "careful (æ…é‡ãª)", "useful (å½¹ã«ç«‹ã¤)"], "note": None},
    {"suffix": "-cal", "pos": "å½¢å®¹è©", "examples": ["local (åœ°å…ƒã®)", "historical (æ­´å²çš„ãª)", "economical (çµŒæ¸ˆçš„ãª)"], "note": None},
    {"suffix": "-cial", "pos": "å½¢å®¹è©", "examples": ["financial (è²¡æ”¿ã®)", "special (ç‰¹åˆ¥ãª)", "official (å…¬å¼ãª)"], "note": None},
    {"suffix": "-nal", "pos": "å½¢å®¹è©", "examples": ["international (å›½éš›çš„ãª)", "additional (è¿½åŠ ã®)", "personal (å€‹äººçš„ãª)"], "note": None},
    {"suffix": "-ive", "pos": "å½¢å®¹è©", "examples": ["expensive (å€¤æ®µãŒé«˜ã„)", "effective (åŠ¹æœçš„ãª)", "competitive (ç«¶äº‰åŠ›ã®ã‚ã‚‹)"], "note": None},
    # å‰¯è©ã®èªå°¾
    {"suffix": "-ly", "pos": "å‰¯è©", "examples": ["usually (æ™®é€šã¯)", "recently (æœ€è¿‘)", "frequently (é »ç¹ã«)"], "note": "ã€è¦æ³¨æ„ã€‘åè©ã« -ly ãŒã¤ãã¨å½¢å®¹è©ã«ãªã‚‹ã‚‚ã®ãŒã‚ã‚Šã¾ã™ (ä¾‹: friendly, costly, timely, daily)ã€‚"},
    # -ly ãŒå½¢å®¹è©ã«ãªã‚‹ã‚±ãƒ¼ã‚¹ã‚‚å€‹åˆ¥ã«è¿½åŠ  (ã‚¯ã‚¤ã‚ºã®ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ã¨ã—ã¦)
    {"suffix": "-ly (ä¾‹å¤–)", "pos": "å½¢å®¹è©", "examples": ["friendly (è¦ªåˆ‡ãª)", "costly (è²»ç”¨ã®ã‹ã‹ã‚‹)", "orderly (æ•´ç„¶ã¨ã—ãŸ)", "timely (ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®ã„ã„)", "daily (æ¯æ—¥ã®)"], "note": "ã“ã‚Œã‚‰ã¯åè©ã« -ly ãŒã¤ã„ã¦å½¢å®¹è©ã«ãªã£ãŸä¾‹ã§ã™ã€‚"},
]

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã®åˆæœŸåŒ–é–¢æ•°
def initialize_session_state():
    if "suffix_list" not in st.session_state:
        st.session_state.suffix_list = random.sample(suffix_data_list, len(suffix_data_list))
    if "current_suffix_index" not in st.session_state:
        st.session_state.current_suffix_index = 0
    if "suffix_score" not in st.session_state:
        st.session_state.suffix_score = 0
    if "suffix_answered" not in st.session_state:
        st.session_state.suffix_answered = False
    if "suffix_user_choice" not in st.session_state:
        st.session_state.suffix_user_choice = None
    if "suffix_show_feedback" not in st.session_state:
        st.session_state.suffix_show_feedback = False

# å›ç­”ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°
def handle_suffix_answer(choice, correct_pos):
    st.session_state.suffix_answered = True
    st.session_state.suffix_user_choice = choice
    st.session_state.suffix_show_feedback = True
    if choice == correct_pos:
        st.session_state.suffix_score += 1

# æ¬¡ã®å•é¡Œã¸é€²ã‚€é–¢æ•°
def next_suffix_question():
    st.session_state.current_suffix_index += 1
    st.session_state.suffix_answered = False
    st.session_state.suffix_user_choice = None
    st.session_state.suffix_show_feedback = False

# --- ã‚¢ãƒ—ãƒªã®ãƒ¡ã‚¤ãƒ³éƒ¨åˆ† ---
def main():
    st.set_page_config(page_title="èªå°¾ã§å“è©ã‚¯ã‚¤ã‚º", layout="centered")
    st.title("ğŸ” èªå°¾ã§å“è©ã‚¯ã‚¤ã‚º")
    st.markdown("è¡¨ç¤ºã•ã‚ŒãŸèªå°¾ãŒã€ä¸»ã«ã©ã®å“è©ã§ä½¿ã‚ã‚Œã‚‹ã‹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚")
    st.divider()

    initialize_session_state()

    suffix_list = st.session_state.suffix_list
    current_index = st.session_state.current_suffix_index

    if current_index < len(suffix_list):
        question_data = suffix_list[current_index]
        suffix_to_guess = question_data["suffix"]
        correct_pos = question_data["pos"]
        example_words = question_data["examples"]
        note_text = question_data["note"]

        st.subheader(f"å•é¡Œ {current_index + 1} / {len(suffix_list)}")
        # èªå°¾ã‚’å¤§ããè¡¨ç¤º
        if suffix_to_guess == "-ly (ä¾‹å¤–)":
            st.markdown(f"<h2 style='text-align: center; color: #FF6347;'>-ly</h2>", unsafe_allow_html=True)
            st.markdown("<p style='text-align: center;'>â€» ãŸã ã—ã€ã“ã‚ŒãŒå½¢å®¹è©ã«ãªã‚‹å ´åˆã®ä¾‹ã§ã™ã€‚</p>", unsafe_allow_html=True)
        else:
            st.markdown(f"<h2 style='text-align: center; color: #1E90FF;'>{suffix_to_guess}</h2>", unsafe_allow_html=True)
        st.markdown("---")

        # å“è©ã®é¸æŠè‚¢
        pos_options = ["åè©", "å‹•è©", "å½¢å®¹è©", "å‰¯è©"]

        if not st.session_state.suffix_show_feedback:
            cols = st.columns(len(pos_options))
            for i, option in enumerate(pos_options):
                with cols[i]:
                    if st.button(option, key=f"pos_button_{option}_{current_index}", use_container_width=True, type="primary"):
                        handle_suffix_answer(option, correct_pos)
                        st.rerun()

        if st.session_state.suffix_show_feedback:
            user_choice = st.session_state.suffix_user_choice
            if user_choice == correct_pos:
                st.success(f"æ­£è§£ï¼ ğŸ‰ ã€Œ{suffix_to_guess}ã€ã¯ä¸»ã« **{correct_pos}** ã®èªå°¾ã§ã™ã€‚")
            else:
                st.error(f"æ®‹å¿µï¼ ã€Œ{suffix_to_guess}ã€ã®ä¸»ãªå“è©ã¯ **{correct_pos}** ã§ã—ãŸã€‚(ã‚ãªãŸã®å›ç­”: {user_choice})")

            st.markdown("**å˜èªä¾‹:**")
            for ex in example_words:
                st.markdown(f"- {ex}")

            if note_text:
                st.info(f"ğŸ“ **è£œè¶³:** {note_text}")
            st.markdown("---")

            if st.button("æ¬¡ã®å•é¡Œã¸", key=f"next_suffix_button_{current_index}", use_container_width=True):
                next_suffix_question()
                st.rerun()

    else: # å…¨å•çµ‚äº†
        st.balloons()
        st.header("ğŸ‰ ã‚¯ã‚¤ã‚ºçµ‚äº†ï¼ ğŸ‰")
        st.subheader("ã‚ãªãŸã®æˆç¸¾:")
        accuracy = (st.session_state.suffix_score / len(suffix_list)) * 100 if len(suffix_list) > 0 else 0
        st.markdown(f"**ğŸ“– ç·å•é¡Œæ•°:** {len(suffix_list)}")
        st.markdown(f"**âœ… æ­£è§£æ•°:** {st.session_state.suffix_score}")
        st.markdown(f"**ğŸ¯ æ­£ç­”ç‡:** {accuracy:.2f}%")
        st.divider()

        if st.button("ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã™ã‚‹", use_container_width=True, type="primary"):
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦å†é–‹
            keys_to_delete = [key for key in st.session_state.keys() if key.startswith("suffix_") or key == "current_suffix_index"]
            for key in keys_to_delete:
                del st.session_state[key]
            st.rerun()

if __name__ == "__main__":
    main()
